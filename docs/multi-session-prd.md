# å¤šä¼šè¯åŠŸèƒ½ PRD

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èƒŒæ™¯
å½“å‰ claude-tg-bridge ä»…æ”¯æŒå•ä¸€ä¼šè¯æ¨¡å¼ï¼šä¸€ä¸ª Telegram ç”¨æˆ·å¯¹åº”ä¸€ä¸ª Claude CLI è¿›ç¨‹ã€‚è¿™åœ¨ä»¥ä¸‹åœºæ™¯å­˜åœ¨å±€é™ï¼š

- ç”¨æˆ·éœ€è¦åœ¨ä¸åŒé¡¹ç›®/ä¸Šä¸‹æ–‡ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œå¿…é¡»é‡å¯ä¼šè¯ï¼Œä¸¢å¤±ä¹‹å‰çš„å¯¹è¯å†å²
- æ— æ³•åŒæ—¶ç»´æŠ¤å¤šä¸ªç‹¬ç«‹çš„å·¥ä½œä¸Šä¸‹æ–‡ï¼ˆå¦‚ï¼šä¸€ä¸ªå¤„ç†å‰ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªå¤„ç†åç«¯ä»»åŠ¡ï¼‰
- é•¿ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œæ— æ³•åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯å¤„ç†ç´§æ€¥äº‹åŠ¡

### 1.2 ç›®æ ‡
å®ç°**å•ç”¨æˆ·å¤šä¼šè¯åˆ‡æ¢**åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥åƒä½¿ç”¨èŠå¤©è½¯ä»¶çš„å¤šä¸ªå¯¹è¯ä¸€æ ·ï¼Œåœ¨ä¸åŒçš„ Claude ä¼šè¯ä¹‹é—´è‡ªç”±åˆ‡æ¢ã€‚

### 1.3 æˆåŠŸæŒ‡æ ‡
- ç”¨æˆ·å¯åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤å¤šä¸ªç‹¬ç«‹ä¼šè¯
- å„ä¼šè¯ä¿æŒç‹¬ç«‹çš„ä¸Šä¸‹æ–‡å’Œå·¥ä½œç›®å½•
- ä¼šè¯åˆ‡æ¢å»¶è¿Ÿ < 500ms
- æ”¯æŒè‡³å°‘ 5 ä¸ªå¹¶å‘ä¼šè¯

---

## 2. ç”¨æˆ·åœºæ™¯

### åœºæ™¯ Aï¼šå¤šé¡¹ç›®å¹¶è¡Œ
```
ç”¨æˆ·æ­£åœ¨ç”¨ä¼šè¯1å¤„ç†é¡¹ç›®Açš„å‰ç«¯å¼€å‘
çªç„¶éœ€è¦ç´§æ€¥ä¿®å¤é¡¹ç›®Bçš„åç«¯bug
â†’ åˆ›å»ºä¼šè¯2ï¼ŒæŒ‡å®šé¡¹ç›®Bçš„å·¥ä½œç›®å½•
â†’ åœ¨ä¼šè¯2ä¸­å®Œæˆä¿®å¤
â†’ åˆ‡å›ä¼šè¯1ç»§ç»­å‰ç«¯å¼€å‘ï¼ˆä¸Šä¸‹æ–‡å®Œæ•´ä¿ç•™ï¼‰
```

### åœºæ™¯ Bï¼šé•¿ä»»åŠ¡ä¸å³æ—¶ä»»åŠ¡åˆ†ç¦»
```
ä¼šè¯1æ­£åœ¨æ‰§è¡Œè€—æ—¶çš„ä»£ç é‡æ„ä»»åŠ¡
ç”¨æˆ·éœ€è¦å¿«é€ŸæŸ¥è¯¢æŸä¸ªAPIç”¨æ³•
â†’ åˆ‡æ¢åˆ°ä¼šè¯2è¿›è¡Œå¿«é€Ÿé—®ç­”
â†’ ä¼šè¯1ç»§ç»­åœ¨åå°æ‰§è¡Œ
â†’ ä»»åŠ¡å®Œæˆåæ”¶åˆ°é€šçŸ¥
```

### åœºæ™¯ Cï¼šå®éªŒæ€§å¯¹è¯éš”ç¦»
```
ç”¨æˆ·æƒ³å°è¯•ä¸€ä¸ªå¯èƒ½æœ‰é£é™©çš„æ“ä½œ
â†’ åˆ›å»ºä¸´æ—¶ä¼šè¯3è¿›è¡Œå®éªŒ
â†’ å®éªŒå¤±è´¥ï¼Œç›´æ¥åˆ é™¤ä¼šè¯3
â†’ ä¸»ä¼šè¯1ä¿æŒå¹²å‡€ï¼Œä¸å—å½±å“
```

---

## 3. åŠŸèƒ½éœ€æ±‚

### 3.1 ä¼šè¯ç®¡ç†å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `/new [name] [dir]` | åˆ›å»ºæ–°ä¼šè¯ | `/new backend /path/to/backend` |
| `/switch <id\|name>` | åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯ | `/switch 2` æˆ– `/switch backend` |
| `/list` | åˆ—å‡ºæ‰€æœ‰ä¼šè¯ | æ˜¾ç¤º IDã€åç§°ã€çŠ¶æ€ã€å·¥ä½œç›®å½• |
| `/close [id]` | å…³é—­æŒ‡å®šä¼šè¯ | `/close 2`ï¼ˆé»˜è®¤å…³é—­å½“å‰ï¼‰ |
| `/rename <name>` | é‡å‘½åå½“å‰ä¼šè¯ | `/rename frontend-dev` |

### 3.2 ä¼šè¯å±æ€§

æ¯ä¸ªä¼šè¯åŒ…å«ï¼š
- `id`: å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆè‡ªå¢æ•°å­—ï¼‰
- `name`: ç”¨æˆ·å¯è¯»åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ "ä¼šè¯N"ï¼‰
- `workingDirectory`: å·¥ä½œç›®å½•
- `claudeProcess`: Claude CLI è¿›ç¨‹å®ä¾‹
- `status`: çŠ¶æ€ï¼ˆidle/busy/stoppedï¼‰
- `createdAt`: åˆ›å»ºæ—¶é—´
- `lastActiveAt`: æœ€åæ´»è·ƒæ—¶é—´

### 3.3 æ¶ˆæ¯è·¯ç”±

- æ™®é€šæ–‡æœ¬æ¶ˆæ¯ â†’ å‘é€åˆ°**å½“å‰æ´»è·ƒä¼šè¯**
- ä¼šè¯ç®¡ç†å‘½ä»¤ â†’ ç”± SessionManager å¤„ç†
- ä¼šè¯å†…å‘½ä»¤ï¼ˆ/stop, /statusï¼‰â†’ ä½œç”¨äºå½“å‰ä¼šè¯

### 3.4 çŠ¶æ€æ˜¾ç¤º

**ä¼šè¯åˆ—è¡¨æ ¼å¼ï¼š**
```
ğŸ“‹ ä¼šè¯åˆ—è¡¨

â†’ [1] frontend (æ´»è·ƒ)
    ğŸ“ /Users/xxx/project-a
    ğŸ’¬ 12æ¡æ¶ˆæ¯ | â± è¿è¡Œ23åˆ†é’Ÿ

  [2] backend (ç©ºé—²)
    ğŸ“ /Users/xxx/project-b
    ğŸ’¬ 5æ¡æ¶ˆæ¯ | â± è¿è¡Œ45åˆ†é’Ÿ

  [3] temp (å·²åœæ­¢)
    ğŸ“ /tmp/experiment
```

**å½“å‰ä¼šè¯æŒ‡ç¤ºï¼š**
- æ¯æ¡æ¶ˆæ¯å‰æ˜¾ç¤ºå½“å‰ä¼šè¯æ ‡è¯†ï¼š`[frontend] ğŸ“¤ æ­£åœ¨æ‰§è¡Œ...`
- æˆ–åœ¨ä¼šè¯åˆ‡æ¢æ—¶å‘é€æç¤ºï¼š`âœ… å·²åˆ‡æ¢åˆ°ä¼šè¯ [2] backend`

### 3.5 èµ„æºé™åˆ¶

- æœ€å¤§å¹¶å‘ä¼šè¯æ•°ï¼š5ï¼ˆå¯é…ç½®ï¼‰
- ç©ºé—²ä¼šè¯è‡ªåŠ¨ä¼‘çœ ï¼š30åˆ†é’Ÿæ— æ´»åŠ¨åæš‚åœè¿›ç¨‹ï¼ˆå¯é…ç½®ï¼‰
- ä¼‘çœ ä¼šè¯è‡ªåŠ¨å”¤é†’ï¼šæ”¶åˆ°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ¢å¤

---

## 4. æŠ€æœ¯è®¾è®¡

### 4.1 æ¶æ„å˜æ›´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Bridge                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Telegram   â”‚â—„â”€â”€â–ºâ”‚    SessionManager       â”‚    â”‚
â”‚  â”‚  BotClient  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ Session 1       â”‚    â”‚    â”‚
â”‚                     â”‚  â”‚  â””â”€ClaudeProcessâ”‚    â”‚    â”‚
â”‚                     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚    â”‚
â”‚                     â”‚  â”‚ Session 2       â”‚    â”‚    â”‚
â”‚                     â”‚  â”‚  â””â”€ClaudeProcessâ”‚    â”‚    â”‚
â”‚                     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚    â”‚
â”‚                     â”‚  â”‚ Session N       â”‚    â”‚    â”‚
â”‚                     â”‚  â”‚  â””â”€ClaudeProcessâ”‚    â”‚    â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ–°å¢æ¨¡å—

#### SessionManager (`src/session/manager.ts`)
```typescript
interface Session {
  id: number;
  name: string;
  workingDirectory: string;
  process: ClaudeProcess;
  status: 'idle' | 'busy' | 'stopped' | 'sleeping';
  createdAt: Date;
  lastActiveAt: Date;
  messageCount: number;
}

class SessionManager extends EventEmitter {
  private sessions: Map<number, Session>;
  private activeSessionId: number | null;
  private nextId: number;
  private maxSessions: number;

  // ä¼šè¯ç®¡ç†
  create(name?: string, workingDir?: string): Session;
  switch(idOrName: number | string): Session;
  close(id?: number): void;
  rename(name: string): void;
  list(): Session[];

  // æ¶ˆæ¯è·¯ç”±
  sendMessage(text: string): Promise<void>;
  getActiveSession(): Session | null;

  // ç”Ÿå‘½å‘¨æœŸ
  sleepSession(id: number): void;
  wakeSession(id: number): void;
}
```

#### Session ç±»å‹å®šä¹‰ (`src/types.ts` æ‰©å±•)
```typescript
interface SessionConfig {
  maxSessions: number;        // é»˜è®¤ 5
  sleepTimeout: number;       // é»˜è®¤ 30åˆ†é’Ÿ
  autoSleep: boolean;         // é»˜è®¤ true
}

interface SessionManagerEvents {
  sessionCreated: (session: Session) => void;
  sessionSwitched: (from: Session | null, to: Session) => void;
  sessionClosed: (session: Session) => void;
  sessionMessage: (sessionId: number, msg: ClaudeMessage) => void;
}
```

### 4.3 æ–‡ä»¶ç»“æ„å˜æ›´

```
src/
â”œâ”€â”€ session/
â”‚   â”œâ”€â”€ index.ts          # å¯¼å‡º
â”‚   â”œâ”€â”€ manager.ts        # SessionManager
â”‚   â””â”€â”€ types.ts          # ä¼šè¯ç›¸å…³ç±»å‹
â”œâ”€â”€ bridge/
â”‚   â”œâ”€â”€ index.ts          # ä¿®æ”¹ï¼šé›†æˆ SessionManager
â”‚   â”œâ”€â”€ claude-process.ts # æ— éœ€ä¿®æ”¹
â”‚   â””â”€â”€ formatter.ts      # æ‰©å±•ï¼šä¼šè¯ç›¸å…³æ ¼å¼åŒ–
â”œâ”€â”€ telegram/
â”‚   â””â”€â”€ bot.ts            # ä¿®æ”¹ï¼šè§£æä¼šè¯å‘½ä»¤
â””â”€â”€ ...
```

### 4.4 å‘½ä»¤è§£ææµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TelegramBot     â”‚
â”‚ è¯†åˆ«æ˜¯å¦ä¸ºå‘½ä»¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
 ä¼šè¯å‘½ä»¤   æ™®é€šæ¶ˆæ¯/å…¶ä»–å‘½ä»¤
    â”‚         â”‚
    â–¼         â–¼
SessionManager  å½“å‰æ´»è·ƒSession
    â”‚              â”‚
    â–¼              â–¼
 æ‰§è¡Œæ“ä½œ    ClaudeProcess
```

### 4.5 ä¼šè¯åˆ‡æ¢æµç¨‹

```
/switch 2
    â”‚
    â–¼
æ£€æŸ¥ä¼šè¯2æ˜¯å¦å­˜åœ¨
    â”‚
    â”œâ”€ ä¸å­˜åœ¨ â†’ è¿”å›é”™è¯¯
    â”‚
    â–¼
æ£€æŸ¥ä¼šè¯2çŠ¶æ€
    â”‚
    â”œâ”€ sleeping â†’ å”¤é†’è¿›ç¨‹
    â”‚
    â–¼
æ›´æ–° activeSessionId
    â”‚
    â–¼
é€šçŸ¥ç”¨æˆ·åˆ‡æ¢æˆåŠŸ
```

---

## 5. é…ç½®æ‰©å±•

```json
{
  "telegram": { ... },
  "claude": { ... },
  "session": {
    "maxSessions": 5,
    "sleepTimeoutMinutes": 30,
    "autoSleep": true,
    "defaultWorkingDirectory": "/Users/xxx/projects"
  }
}
```

---

## 6. å®ç°è®¡åˆ’

### Phase 1: åŸºç¡€å¤šä¼šè¯ (MVP)
- [ ] åˆ›å»º SessionManager åŸºç¡€ç»“æ„
- [ ] å®ç° `/new`, `/switch`, `/list`, `/close` å‘½ä»¤
- [ ] ä¿®æ”¹ Bridge é›†æˆ SessionManager
- [ ] æ¶ˆæ¯æ­£ç¡®è·¯ç”±åˆ°å½“å‰ä¼šè¯
- [ ] åŸºç¡€çŠ¶æ€æ˜¾ç¤º

### Phase 2: å¢å¼ºåŠŸèƒ½
- [ ] ä¼šè¯å‘½åä¸ `/rename`
- [ ] ä¼šè¯çŠ¶æ€æŒä¹…åŒ–ï¼ˆé‡å¯åæ¢å¤ï¼‰
- [ ] ç©ºé—²è‡ªåŠ¨ä¼‘çœ /å”¤é†’
- [ ] ä¼šè¯çº§åˆ«çš„ /status å’Œ /session ä¿¡æ¯

### Phase 3: ä¼˜åŒ–ä½“éªŒ
- [ ] ä¼šè¯å¿«æ·åˆ‡æ¢ï¼ˆæ•°å­—é”®ç›˜ 1-5ï¼‰
- [ ] åå°ä»»åŠ¡å®Œæˆé€šçŸ¥
- [ ] ä¼šè¯å†å²è®°å½•ï¼ˆå¯é€‰ï¼‰

---

## 7. é£é™©ä¸æ³¨æ„äº‹é¡¹

### 7.1 èµ„æºç®¡ç†
- æ¯ä¸ª Claude è¿›ç¨‹å ç”¨çº¦ 50-100MB å†…å­˜
- 5 ä¸ªå¹¶å‘ä¼šè¯æœ€å¤šå ç”¨ 500MB
- éœ€è¦å®ç°è‡ªåŠ¨ä¼‘çœ æœºåˆ¶æ§åˆ¶èµ„æº

### 7.2 æ¶ˆæ¯ç«äº‰
- åŒä¸€ç”¨æˆ·å¿«é€Ÿå‘é€å¤šæ¡æ¶ˆæ¯æ—¶ï¼Œç¡®ä¿æŒ‰åºå¤„ç†
- ä¼šè¯åˆ‡æ¢æœŸé—´çš„æ¶ˆæ¯éœ€æ­£ç¡®è·¯ç”±

### 7.3 é”™è¯¯å¤„ç†
- ä¼šè¯è¿›ç¨‹å´©æºƒæ—¶çš„æ¢å¤ç­–ç•¥
- è¾¾åˆ°æœ€å¤§ä¼šè¯æ•°æ—¶çš„å‹å¥½æç¤º
- åˆ‡æ¢åˆ°å·²å…³é—­ä¼šè¯çš„å¤„ç†

### 7.4 å‘åå…¼å®¹
- ç°æœ‰å•ä¼šè¯ç”¨æˆ·æ— éœ€å­¦ä¹ æ–°å‘½ä»¤å³å¯ä½¿ç”¨
- é»˜è®¤å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»º "é»˜è®¤" ä¼šè¯

---

## 8. éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´**ï¼šæ‰€æœ‰ Phase 1 å‘½ä»¤å¯æ­£å¸¸å·¥ä½œ
2. **éš”ç¦»æ€§**ï¼šå„ä¼šè¯ä¸Šä¸‹æ–‡å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
3. **ç¨³å®šæ€§**ï¼šè¿ç»­è¿è¡Œ 24 å°æ—¶æ— å†…å­˜æ³„æ¼
4. **æ˜“ç”¨æ€§**ï¼šæ–°ç”¨æˆ· 5 åˆ†é’Ÿå†…ç†è§£å¹¶ä½¿ç”¨å¤šä¼šè¯åŠŸèƒ½
5. **æ€§èƒ½**ï¼šä¼šè¯åˆ‡æ¢å»¶è¿Ÿ < 500ms

---

## é™„å½•ï¼šå‘½ä»¤é€ŸæŸ¥

```
/new [name] [dir]     åˆ›å»ºæ–°ä¼šè¯
/switch <id|name>     åˆ‡æ¢ä¼šè¯
/list                 åˆ—å‡ºæ‰€æœ‰ä¼šè¯
/close [id]           å…³é—­ä¼šè¯
/rename <name>        é‡å‘½åå½“å‰ä¼šè¯
/status               å½“å‰ä¼šè¯çŠ¶æ€
/session              å½“å‰ä¼šè¯è¯¦æƒ…
/stop                 åœæ­¢å½“å‰ä¼šè¯ä»»åŠ¡
/restart              é‡å¯å½“å‰ä¼šè¯
```
